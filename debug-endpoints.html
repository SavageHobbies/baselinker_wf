<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n Endpoint Debug Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="py-10">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">n8n Endpoint Debug Tool</h1>
        
        <div class="space-y-6">
            <!-- Test UPC Input -->
            <div>
                <label for="testUpc" class="block text-sm font-medium text-gray-700 mb-2">Test UPC (for product details test):</label>
                <input type="text" id="testUpc" placeholder="Enter a UPC to test" 
                       class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <!-- Endpoint Tests -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Inventory Test -->
                <div class="border rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-3">1. Full Inventory Test</h2>
                    <p class="text-sm text-gray-600 mb-3">Tests: https://n8n.by1.net/webhook/full-inventory</p>
                    <button id="testInventory" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                        Test Inventory Endpoint
                    </button>
                    <div id="inventoryResult" class="mt-3 p-3 bg-gray-100 rounded text-sm hidden"></div>
                </div>

                <!-- Product Details Test -->
                <div class="border rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-3">2. Single Product Test</h2>
                    <p class="text-sm text-gray-600 mb-3">Tests: https://n8n.by1.net/webhook/get-single-product-details</p>
                    <button id="testProduct" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                        Test Product Details
                    </button>
                    <div id="productResult" class="mt-3 p-3 bg-gray-100 rounded text-sm hidden"></div>
                </div>

                <!-- Enrich Product Test -->
                <div class="border rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-3">3. Enrich Product Test</h2>
                    <p class="text-sm text-gray-600 mb-3">Tests: https://n8n.by1.net/webhook/enrich-product</p>
                    <button id="testEnrich" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700">
                        Test Enrich Endpoint
                    </button>
                    <div id="enrichResult" class="mt-3 p-3 bg-gray-100 rounded text-sm hidden"></div>
                </div>

                <!-- Save Images Test -->
                <div class="border rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-3">4. Save Images Test</h2>
                    <p class="text-sm text-gray-600 mb-3">Tests: https://n8n.by1.net/webhook/product-images</p>
                    <button id="testSaveImages" class="w-full bg-yellow-600 text-white py-2 px-4 rounded hover:bg-yellow-700">
                        Test Save Images
                    </button>
                    <div id="saveImagesResult" class="mt-3 p-3 bg-gray-100 rounded text-sm hidden"></div>
                </div>

                <!-- Update Product Test -->
                <div class="border rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-3">5. Update Product Test</h2>
                    <p class="text-sm text-gray-600 mb-3">Tests: https://n8n.by1.net/webhook/edit-update</p>
                    <button id="testUpdate" class="w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
                        Test Update Endpoint
                    </button>
                    <div id="updateResult" class="mt-3 p-3 bg-gray-100 rounded text-sm hidden"></div>
                </div>

                <!-- Scan UPC Test -->
                <div class="border rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-3">6. Scan UPC Test</h2>
                    <p class="text-sm text-gray-600 mb-3">Tests: https://n8n.by1.net/webhook/scan-upc</p>
                    <button id="testScan" class="w-full bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700">
                        Test Scan Endpoint
                    </button>
                    <div id="scanResult" class="mt-3 p-3 bg-gray-100 rounded text-sm hidden"></div>
                </div>
            </div>

            <!-- Combined Results Summary -->
            <div class="border-t pt-6">
                <h2 class="text-xl font-semibold mb-4">Summary & Recommendations</h2>
                <div id="summary" class="p-4 bg-blue-50 rounded-lg">
                    <p class="text-gray-600">Run the tests above to see detailed diagnostics and recommendations.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - same URLs as used in your other pages
        const endpoints = {
            inventory: 'https://n8n.by1.net/webhook/full-inventory',
            productDetails: 'https://n8n.by1.net/webhook/get-single-product-details',
            enrichProduct: 'https://n8n.by1.net/webhook/enrich-product',
            saveImages: 'https://n8n.by1.net/webhook/product-images',
            updateProduct: 'https://n8n.by1.net/webhook/edit-update',
            scanUpc: 'https://n8n.by1.net/webhook/scan-upc'
        };

        let testResults = {};

        // Utility functions
        function escapeHtml(unsafe) {
            if (unsafe === null || typeof unsafe === 'undefined') return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showResult(elementId, status, message, details = null) {
            const element = document.getElementById(elementId);
            element.classList.remove('hidden');
            
            let statusClass = 'bg-gray-100';
            let statusText = 'Unknown';
            
            if (status === 'success') {
                statusClass = 'bg-green-100 text-green-800';
                statusText = '✅ SUCCESS';
            } else if (status === 'error') {
                statusClass = 'bg-red-100 text-red-800';
                statusText = '❌ ERROR';
            } else if (status === 'warning') {
                statusClass = 'bg-yellow-100 text-yellow-800';
                statusText = '⚠️ WARNING';
            }
            
            element.className = `mt-3 p-3 rounded text-sm ${statusClass}`;
            element.innerHTML = `
                <div class="font-medium">${statusText}</div>
                <div class="mt-1">${escapeHtml(message)}</div>
                ${details ? `<details class="mt-2"><summary class="cursor-pointer font-medium">Technical Details</summary><pre class="mt-1 text-xs overflow-auto">${escapeHtml(details)}</pre></details>` : ''}
            `;
        }

        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = 'Testing...';
                button.classList.add('opacity-50');
            } else {
                button.disabled = false;
                button.classList.remove('opacity-50');
                // Restore original text based on button id
                const originalTexts = {
                    'testInventory': 'Test Inventory Endpoint',
                    'testProduct': 'Test Product Details',
                    'testEnrich': 'Test Enrich Endpoint',
                    'testSaveImages': 'Test Save Images',
                    'testUpdate': 'Test Update Endpoint',
                    'testScan': 'Test Scan Endpoint'
                };
                button.innerHTML = originalTexts[buttonId] || 'Test';
            }
        }

        async function testEndpoint(url, method = 'GET', body = null, resultElementId, testName, buttonId) {
            setButtonLoading(buttonId, true);
            
            try {
                console.log(`Testing ${testName}: ${method} ${url}`);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const startTime = Date.now();
                const response = await fetch(url, options);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                console.log(`${testName} Response:`, response.status, response.statusText);
                
                const responseText = await response.text();
                console.log(`${testName} Response Text:`, responseText);
                
                let responseData = null;
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    console.log(`${testName} - Could not parse as JSON:`, e);
                }
                
                if (response.ok) {
                    testResults[testName] = { status: 'success', code: response.status, time: responseTime };
                    showResult(resultElementId, 'success', 
                        `Endpoint is working! Response time: ${responseTime}ms`, 
                        `Status: ${response.status}\nResponse: ${responseText.substring(0, 500)}${responseText.length > 500 ? '...' : ''}`);
                } else {
                    testResults[testName] = { status: 'error', code: response.status, time: responseTime };
                    showResult(resultElementId, 'error', 
                        `HTTP Error ${response.status}: ${response.statusText}`, 
                        `Response: ${responseText.substring(0, 500)}${responseText.length > 500 ? '...' : ''}`);
                }
                
            } catch (error) {
                console.error(`${testName} Error:`, error);
                testResults[testName] = { status: 'error', error: error.message };
                
                let errorMessage = 'Network/CORS Error';
                let details = error.toString();
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'CORS or Network Error - likely the endpoint is not accessible from the browser';
                    details = `This usually means:\n1. CORS is not configured on the n8n webhook\n2. The n8n instance is not running\n3. The URL is incorrect\n4. Network connectivity issues\n\nOriginal error: ${error.message}`;
                }
                
                showResult(resultElementId, 'error', errorMessage, details);
            } finally {
                setButtonLoading(buttonId, false);
                updateSummary();
            }
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            const totalTests = Object.keys(testResults).length;
            const successfulTests = Object.values(testResults).filter(r => r.status === 'success').length;
            const failedTests = totalTests - successfulTests;
            
            if (totalTests === 0) {
                summary.innerHTML = '<p class="text-gray-600">Run the tests above to see detailed diagnostics and recommendations.</p>';
                return;
            }
            
            let summaryHtml = `
                <div class="mb-4">
                    <h3 class="font-semibold">Test Results: ${successfulTests}/${totalTests} endpoints working</h3>
                </div>
            `;
            
            if (failedTests > 0) {
                summaryHtml += `
                    <div class="mb-4 p-3 bg-red-50 rounded border-l-4 border-red-400">
                        <h4 class="font-medium text-red-800">Issues Found:</h4>
                        <ul class="list-disc list-inside text-red-700 text-sm mt-2">
                `;
                
                Object.entries(testResults).forEach(([testName, result]) => {
                    if (result.status === 'error') {
                        if (result.error && (result.error.includes('fetch') || result.error.includes('CORS'))) {
                            summaryHtml += `<li>${testName}: CORS/Network issue - check n8n configuration</li>`;
                        } else if (result.code) {
                            summaryHtml += `<li>${testName}: HTTP ${result.code} error</li>`;
                        } else {
                            summaryHtml += `<li>${testName}: ${result.error || 'Unknown error'}</li>`;
                        }
                    }
                });
                
                summaryHtml += `
                        </ul>
                    </div>
                    <div class="mb-4 p-3 bg-blue-50 rounded border-l-4 border-blue-400">
                        <h4 class="font-medium text-blue-800">Recommended Fixes:</h4>
                        <ol class="list-decimal list-inside text-blue-700 text-sm mt-2">
                            <li>Check if your n8n instance is running and accessible</li>
                            <li>Verify the webhook URLs are correct in n8n</li>
                            <li>Configure CORS in n8n settings to allow your domain</li>
                            <li>Test the webhooks directly in n8n or with a tool like Postman</li>
                            <li>Check browser developer console for specific CORS errors</li>
                        </ol>
                    </div>
                `;
            } else {
                summaryHtml += `
                    <div class="p-3 bg-green-50 rounded border-l-4 border-green-400">
                        <h4 class="font-medium text-green-800">All endpoints are working!</h4>
                        <p class="text-green-700 text-sm mt-1">Your n8n workflows appear to be properly configured and accessible.</p>
                    </div>
                `;
            }
            
            summary.innerHTML = summaryHtml;
        }

        // Event listeners
        document.getElementById('testInventory').addEventListener('click', () => {
            testEndpoint(endpoints.inventory, 'GET', null, 'inventoryResult', 'Inventory', 'testInventory');
        });

        document.getElementById('testProduct').addEventListener('click', () => {
            const testUpc = document.getElementById('testUpc').value.trim() || '123456789012';
            testEndpoint(`${endpoints.productDetails}?upc=${encodeURIComponent(testUpc)}`, 'GET', null, 'productResult', 'Product Details', 'testProduct');
        });

        document.getElementById('testEnrich').addEventListener('click', () => {
            const testUpc = document.getElementById('testUpc').value.trim() || '123456789012';
            testEndpoint(endpoints.enrichProduct, 'POST', { upc: testUpc }, 'enrichResult', 'Enrich Product', 'testEnrich');
        });

        document.getElementById('testSaveImages').addEventListener('click', () => {
            const testUpc = document.getElementById('testUpc').value.trim() || '123456789012';
            const testPayload = {
                upc: testUpc,
                selected_images: [
                    { url: 'https://example.com/test.jpg', order: 1, is_main: true, source: 'test' }
                ]
            };
            testEndpoint(endpoints.saveImages, 'POST', testPayload, 'saveImagesResult', 'Save Images', 'testSaveImages');
        });

        document.getElementById('testUpdate').addEventListener('click', () => {
            const testUpc = document.getElementById('testUpc').value.trim() || '123456789012';
            const testPayload = {
                upc: testUpc,
                title: 'Test Product Update'
            };
            testEndpoint(endpoints.updateProduct, 'POST', testPayload, 'updateResult', 'Update Product', 'testUpdate');
        });

        document.getElementById('testScan').addEventListener('click', () => {
            const testUpc = document.getElementById('testUpc').value.trim() || '123456789012';
            testEndpoint(endpoints.scanUpc, 'POST', { upc: testUpc }, 'scanResult', 'Scan UPC', 'testScan');
        });
    </script>
</body>
</html>
