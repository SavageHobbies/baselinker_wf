<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-TF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Product & Enrich</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 600px;
        }
        /* Custom styles for loader */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        .small-loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, bottom 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .toast.show {
            opacity: 1;
            bottom: 30px;
        }
        .toast.success {
            background-color: #28a745; /* Green */
        }
        .toast.error {
            background-color: #dc3545; /* Red */
        }
        .gemini-feature-button {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .gemini-feature-button:hover {
            background-color: #4338ca; /* Darker Indigo */
        }
        .gemini-feature-button:disabled {
            background-color: #a5b4fc; /* Lighter Indigo, disabled */
            cursor: not-allowed;
        }
        #scanLogArea .log-entry-success { color: #155724; background-color: #d4edda; border-left: 3px solid #28a745;}
        #scanLogArea .log-entry-error { color: #721c24; background-color: #f8d7da; border-left: 3px solid #dc3545;}
        #scanLogArea .log-entry { padding: 4px 8px; margin-bottom: 4px; border-radius: 4px;}

    </style>
</head>
<body class="flex items-center justify-center min-h-screen py-12">
    <div class="container bg-white p-8 rounded-xl shadow-2xl w-full mx-4 md:mx-0">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Scan Product & Enrich</h1>

        <div class="space-y-6">
            <div>
                <label for="upcInput" class="block text-sm font-medium text-gray-700 mb-1">Enter Product Code (UPC, GTIN, etc.)</label>
                <input type="text" id="upcInput" name="upcInput"
                       class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition duration-150 ease-in-out"
                       placeholder="e.g., 123456789012">
            </div>

            <button id="scanButton"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                Submit Code
            </button>
        </div>

        <div id="loader" class="loader hidden"></div>

        <div id="responseArea" class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner min-h-[100px] text-sm text-gray-700">
            <p id="initialMessage" class="text-center text-gray-500 italic">Scan results will appear here.</p>
            <div id="scanResultDetails"></div>
            
            <div id="geminiFeatures" class="mt-6 border-t border-gray-200 pt-6 hidden space-y-4">
                <h4 class="text-md font-semibold text-gray-700">âœ¨ AI Powered Enrichment:</h4>
                <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-3 sm:space-y-0">
                    <button id="suggestCategoryButton" class="gemini-feature-button flex-1">Suggest Category</button>
                    <button id="draftDescriptionButton" class="gemini-feature-button flex-1">Draft Description</button>
                </div>
                <div id="categoryResult" class="mt-3 p-3 bg-indigo-50 rounded-md text-indigo-800 hidden"></div>
                <div id="descriptionResult" class="mt-3 p-3 bg-purple-50 rounded-md text-purple-800 hidden"></div>
            </div>
        </div>

        <div class="mt-8">
            <h4 class="text-md font-semibold text-gray-700 mb-2">Recent Scans Log:</h4>
            <div id="scanLogArea" class="h-40 overflow-y-auto bg-gray-100 p-3 rounded-md border border-gray-200 text-xs space-y-1">
                <p id="scanLogPlaceholder" class="text-center text-gray-400 italic">No scans yet.</p>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const upcInput = document.getElementById('upcInput');
        const scanButton = document.getElementById('scanButton');
        const responseArea = document.getElementById('responseArea');
        const initialMessage = document.getElementById('initialMessage');
        const scanResultDetails = document.getElementById('scanResultDetails');
        const loader = document.getElementById('loader');
        const toast = document.getElementById('toast');
        const scanLogArea = document.getElementById('scanLogArea');
        const scanLogPlaceholder = document.getElementById('scanLogPlaceholder');

        const geminiFeaturesDiv = document.getElementById('geminiFeatures');
        const suggestCategoryButton = document.getElementById('suggestCategoryButton');
        const draftDescriptionButton = document.getElementById('draftDescriptionButton');
        const categoryResultDiv = document.getElementById('categoryResult');
        const descriptionResultDiv = document.getElementById('descriptionResult');

        let currentProductInfo = null; 
        const MAX_LOG_ENTRIES = 10;
        let scanLogEntries = [];

        const N8N_WEBHOOK_URL = 'https://n8n.by1.net/webhook/scan-upc'; 
        const GEMINI_API_URL_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
        const GEMINI_API_KEY = ""; 

        scanButton.addEventListener('click', handleScan);
        upcInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission if inside a form
                handleScan();
            }
        });

        suggestCategoryButton.addEventListener('click', handleSuggestCategory);
        draftDescriptionButton.addEventListener('click', handleDraftDescription);

        function addScanToLog(upc, status, message = '') {
            if (scanLogPlaceholder) {
                scanLogPlaceholder.classList.add('hidden');
            }
            const timestamp = new Date().toLocaleTimeString();
            // No need to create logEntry element here, renderScanLog will do it.
            
            scanLogEntries.unshift({upc, status, message, timestamp}); // Add to beginning
            if (scanLogEntries.length > MAX_LOG_ENTRIES) {
                scanLogEntries.pop(); // Remove oldest if log exceeds max size
            }
            renderScanLog();
        }

        function renderScanLog() {
            scanLogArea.innerHTML = ''; // Clear existing logs
            if (scanLogEntries.length === 0 && scanLogPlaceholder) {
                 scanLogPlaceholder.classList.remove('hidden');
                 return;
            }
            scanLogEntries.forEach(entryData => {
                const logDiv = document.createElement('div');
                logDiv.classList.add('log-entry');
                let statusClass = '';
                let statusText = entryData.status;

                if (entryData.status === 'success') {
                    statusClass = 'log-entry-success';
                    statusText = 'Success';
                } else if (entryData.status === 'error' || entryData.status === 'invalid_code') {
                    statusClass = 'log-entry-error';
                    statusText = entryData.status === 'invalid_code' ? 'Invalid Code' : 'Error';
                }
                logDiv.classList.add(statusClass);
                logDiv.innerHTML = `<strong>[${entryData.timestamp}]</strong> ${escapeHtml(entryData.upc)} - <strong>${statusText}</strong> ${entryData.message ? `- ${escapeHtml(entryData.message)}` : ''}`;
                scanLogArea.appendChild(logDiv);
            });
        }


        async function handleScan() {
            const upcValue = upcInput.value.trim();
            currentProductInfo = null; 
            hideGeminiFeatures(); 

            if (!upcValue) {
                showToast('Please enter a product code.', 'error');
                addScanToLog(upcValue || "Empty", 'error', 'Input was empty');
                upcInput.focus();
                return;
            }
            
            console.log(`Attempting to scan UPC: ${upcValue}`);

            loader.classList.remove('hidden');
            initialMessage.classList.add('hidden');
            scanResultDetails.innerHTML = '<p class="text-center text-gray-500 italic">Processing...</p>';
            scanButton.disabled = true;
            scanButton.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ upc: upcValue }) 
                });
                
                console.log('Response Status:', response.status);
                const responseText = await response.text(); 
                console.log('Raw Response Text:', responseText);

                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                    console.log('Parsed Response Data:', responseData);
                } catch (e) {
                    console.error('Failed to parse JSON response:', e);
                    scanResultDetails.innerHTML = `<h3 class="text-lg font-semibold text-red-700 mb-3">Server Response Error</h3>
                                              <p class="text-red-600">Received an invalid format from the server. Not valid JSON.</p>
                                              <pre class="text-xs bg-red-100 p-2 mt-2 overflow-auto max-h-32">${escapeHtml(responseText)}</pre>`;
                    showToast('Invalid server response.', 'error');
                    addScanToLog(upcValue, 'error', 'Invalid server response (not JSON)');
                    // Ensure finally block runs to re-enable button and focus input
                    return; 
                }


                if (response.ok) {
                    let productDetailsHtml = '<h3 class="text-lg font-semibold text-green-700 mb-3">Scan Successful!</h3>';
                    const product = Array.isArray(responseData) ? responseData[0] : responseData;

                    if (product && typeof product === 'object') {
                        currentProductInfo = { 
                            title: product.title || null,
                            upc: product.upc || upcValue, 
                            code_type: product.code_type || null,
                        };

                        productDetailsHtml += '<ul class="space-y-1 list-disc list-inside">';
                        if (product.title) productDetailsHtml += `<li><strong>Title:</strong> ${escapeHtml(product.title)}</li>`;
                        if (product.upc) productDetailsHtml += `<li><strong>UPC:</strong> ${escapeHtml(product.upc)}</li>`;
                        if (product.code_type) productDetailsHtml += `<li><strong>Code Type:</strong> ${escapeHtml(product.code_type)}</li>`;
                        if (product.quantity !== undefined) productDetailsHtml += `<li><strong>Quantity:</strong> ${escapeHtml(String(product.quantity))}</li>`;
                        if (product.last_scanned_at) productDetailsHtml += `<li><strong>Last Scanned:</strong> ${new Date(product.last_scanned_at).toLocaleString()}</li>`;
                        if (product.created_at) productDetailsHtml += `<li><strong>Created At:</strong> ${new Date(product.created_at).toLocaleString()}</li>`;
                        if (product.enrichment_status) productDetailsHtml += `<li><strong>Enrichment Status:</strong> ${escapeHtml(product.enrichment_status)}</li>`;
                        productDetailsHtml += '</ul>';
                        showGeminiFeatures();
                        addScanToLog(upcValue, 'success', product.title || product.upc);
                    } else {
                        productDetailsHtml += '<p>Received an unexpected data format from the server.</p>';
                        console.warn('Unexpected success response format:', responseData);
                        addScanToLog(upcValue, 'error', 'Unexpected success format');
                    }
                    scanResultDetails.innerHTML = productDetailsHtml;
                    showToast('Product processed successfully!', 'success');
                    upcInput.value = '';
                } else {
                    const errorTitle = responseData.error || responseData.message || `Error ${response.status}`;
                    const errorDetails = responseData.details || (responseData.data ? JSON.stringify(responseData.data) : responseText);
                    
                    scanResultDetails.innerHTML = `<h3 class="text-lg font-semibold text-red-700 mb-3">${escapeHtml(errorTitle)}</h3>
                                              <p class="text-red-600">${escapeHtml(errorDetails)}</p>`;
                    showToast(errorTitle, 'error');
                    addScanToLog(upcValue, responseData.details && responseData.details.includes("INVALID_CODE_FORMAT") ? 'invalid_code' : 'error', errorTitle);
                    console.error('Error from n8n:', responseData);
                }

            } catch (error) {
                console.error('Fetch or other JS error:', error);
                scanResultDetails.innerHTML = `<h3 class="text-lg font-semibold text-red-700 mb-3">Application Error</h3>
                                          <p class="text-red-600">Could not process the request due to a network or script error. Check the browser console for details.</p>
                                          <p class="text-xs text-gray-500 mt-2">Details: ${escapeHtml(error.message)}</p>`;
                showToast('Failed to process request.', 'error');
                addScanToLog(upcValue, 'error', 'Client-side error: ' + error.message);
            } finally {
                loader.classList.add('hidden');
                scanButton.disabled = false;
                scanButton.classList.remove('opacity-50', 'cursor-not-allowed');
                upcInput.focus(); 
            }
        }

        function showGeminiFeatures() {
            if (geminiFeaturesDiv) {
                geminiFeaturesDiv.classList.remove('hidden');
            }
            if (categoryResultDiv) {
                categoryResultDiv.classList.add('hidden');
                categoryResultDiv.innerHTML = '';
            }
            if (descriptionResultDiv) {
                descriptionResultDiv.classList.add('hidden');
                descriptionResultDiv.innerHTML = '';
            }
        }

        function hideGeminiFeatures() {
            if (geminiFeaturesDiv) {
                geminiFeaturesDiv.classList.add('hidden');
            }
            if (categoryResultDiv) {
                categoryResultDiv.classList.add('hidden');
                categoryResultDiv.innerHTML = '';
            }
            if (descriptionResultDiv) {
                descriptionResultDiv.classList.add('hidden');
                descriptionResultDiv.innerHTML = '';
            }
        }

        async function callGeminiAPI(prompt, buttonElement, resultDivElement, resultTitle) {
            if (!currentProductInfo || (!currentProductInfo.title && !currentProductInfo.upc)) {
                showToast('No product information available for AI features.', 'error');
                return;
            }

            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = `Processing... <div class="small-loader"></div>`;
            buttonElement.disabled = true;
            
            if(resultDivElement) {
                resultDivElement.classList.add('hidden');
                resultDivElement.innerHTML = '';
            }


            const requestBody = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(`${GEMINI_API_URL_BASE}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (resultDivElement) {
                        resultDivElement.innerHTML = `<p class="font-medium">${resultTitle}:</p><p class="mt-1 whitespace-pre-wrap">${escapeHtml(text)}</p>`;
                        resultDivElement.classList.remove('hidden');
                    }
                    showToast(`${resultTitle} generated!`, 'success');
                } else {
                    console.error('Unexpected Gemini API response structure:', result);
                    const geminiError = result.error?.message || (result.promptFeedback?.blockReason ? `Blocked: ${result.promptFeedback.blockReason}` : 'Unknown Gemini error.');
                    if (resultDivElement) {
                        resultDivElement.innerHTML = `<p class="font-medium text-red-600">${resultTitle} Error:</p><p class="mt-1">Could not generate content. ${escapeHtml(geminiError)}</p>`;
                        resultDivElement.classList.remove('hidden');
                    }
                    showToast(`Failed to generate ${resultTitle.toLowerCase()}.`, 'error');
                }
            } catch (error) {
                console.error(`Error calling Gemini API for ${resultTitle}:`, error);
                 if (resultDivElement) {
                    resultDivElement.innerHTML = `<p class="font-medium text-red-600">${resultTitle} Error:</p><p class="mt-1">An error occurred: ${escapeHtml(error.message)}</p>`;
                    resultDivElement.classList.remove('hidden');
                }
                showToast('Error connecting to AI service.', 'error');
            } finally {
                buttonElement.innerHTML = originalButtonText;
                buttonElement.disabled = false;
            }
        }

        async function handleSuggestCategory() {
            const productIdentifier = currentProductInfo.title || currentProductInfo.upc;
            const prompt = `Based on the product title or identifier "${productIdentifier}", suggest a suitable e-commerce product category. Provide just the category name.`;
            await callGeminiAPI(prompt, suggestCategoryButton, categoryResultDiv, "Suggested Category");
        }

        async function handleDraftDescription() {
            const productIdentifier = currentProductInfo.title || currentProductInfo.upc;
            const prompt = `Draft a short, engaging product description (1-2 sentences) for a product with the title or identifier "${productIdentifier}". Highlight a key potential benefit.`;
            await callGeminiAPI(prompt, draftDescriptionButton, descriptionResultDiv, "Draft Description");
        }

        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || typeof unsafe === 'undefined') return '';
            return String(unsafe)
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
        
        renderScanLog(); 
    </script>
</body>
</html>
